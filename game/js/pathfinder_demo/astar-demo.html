<!doctype html>
<html>
    <head>
        <title>A-STAR Pathfinding for HTML5 Canvas by @McFunkypants</title>
        <script type='text/javascript' src='js/astar-pathfinding-canvas.js'></script>
    </head>

    <body onload='onload()'>

        <div>
            <input type='button' onClick='createWorld()' value='New World'>
        </div>
        <div>
            <canvas id="gameCanvas"></canvas>
        </div>


        <script>

            var canvas, ctx, spritesheet;
            var spritesheetLoaded = false;
            var world = [[]];
            var worldWidth = 16, worldHeight = 16;
            var tileWidth = 32, tileHeight = 32;

            var pathStart = [worldWidth, worldHeight]; // start and end of path
            var pathEnd = [0, 0];
            var currentPath = [];

            function onload() {

                canvas = document.getElementById('gameCanvas');
                canvas.width = worldWidth * tileWidth;
                canvas.height = worldHeight * tileHeight;
                canvas.addEventListener("click", canvasClick, false);

                ctx = canvas.getContext("2d");
                spritesheet = new Image();
                spritesheet.src = 'spritesheet.png';
                spritesheet.onload = loaded;
            }

            function loaded() {
                console.log('Spritesheet loaded.');
                spritesheetLoaded = true;
                createWorld();
            }

            function createWorld() { // fill the world with RANDOM walls
                console.log('Creating world...');

                for (var x = 0; x < worldWidth; x++) { // create emptiness
                    world[x] = [];

                    for (var y = 0; y < worldHeight; y++) {
                        world[x][y] = 0;
                    }
                }

                for (var x = 0; x < worldWidth; x++) { // scatter some walls
                    for (var y = 0; y < worldHeight; y++)
                    {
                        if (Math.random() > 0.75) {
                            world[x][y] = 1;
                        }
                    }
                }

                currentPath = [];
                while (currentPath.length == 0) { // calculate initial possible path

                    pathStart = [Math.floor(Math.random() * worldWidth), Math.floor(Math.random() * worldHeight)];
                    pathEnd = [Math.floor(Math.random() * worldWidth), Math.floor(Math.random() * worldHeight)];

                    if (world[pathStart[0]][pathStart[1]] == 0) {
                        currentPath = findPath(world, pathStart, pathEnd);
                    }
                }

                redraw();
            }

            function redraw() {
                if (!spritesheetLoaded) {
                    return;
                }

                var spriteNum = 0;
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                for (var x = 0; x < worldWidth; x++) {

                    for (var y = 0; y < worldHeight; y++) {

                        switch (world[x][y]) { // choose a sprite to draw
                            case 1:
                                spriteNum = 1;
                                break;
                            default:
                                spriteNum = 0;
                                break;
                        }

                        // draw it: ctx.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);
                        ctx.drawImage(spritesheet,
                                spriteNum * tileWidth, 0,
                                tileWidth, tileHeight,
                                x * tileWidth, y * tileHeight,
                                tileWidth, tileHeight);
                    }
                }

                for (rp = 0; rp < currentPath.length; rp++) { // draw the path
                    switch (rp) {
                        case 0:
                            spriteNum = 2; // start
                            break;
                        case currentPath.length - 1:
                            spriteNum = 3; // end
                            break;
                        default:
                            spriteNum = 4; // path node
                            break;
                    }

                    ctx.drawImage(spritesheet,
                            spriteNum * tileWidth, 0,
                            tileWidth, tileHeight,
                            currentPath[rp][0] * tileWidth,
                            currentPath[rp][1] * tileHeight,
                            tileWidth, tileHeight);
                }
            }

            function canvasClick(e) { // handle click events on the canvas
                var x;
                var y;

                if (e.pageX != undefined && e.pageY != undefined) { // grab html page coords
                    x = e.pageX;
                    y = e.pageY;
                }
                else {
                    x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                    y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
                }

                // make them relative to the canvas only
                x -= canvas.offsetLeft;
                y -= canvas.offsetTop;

                var cell = [Math.floor(x / tileWidth), Math.floor(y / tileHeight)]; // return tile x,y that we clicked

                pathStart = pathEnd;
                pathEnd = cell;

                currentPath = findPath(world, pathStart, pathEnd); // calculate path
                redraw();
            }

        </script>

    </body>
</html>